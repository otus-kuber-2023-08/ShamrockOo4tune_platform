# –ü–æ–¥—Ö–æ–¥—ã –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é production-grade –∫–ª–∞—Å—Ç–µ—Ä–∞  

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

–¶–µ–ª—å –∑–∞–¥–∞–Ω–∏—è - —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–ª–∞—Å—Ç–µ—Ä –≤–µ—Ä—Å–∏–∏ 1.23 –∏ –æ–±–Ω–æ–≤–∏—Ç—å –µ–≥–æ.  
–†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å –∫–ª–∞—Å—Ç–µ—Ä –±—É–¥—É –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω–∞—Ö –≤ Yandex Cloud  
–î–ª—è —ç—Ç–æ–≥–æ –≤ –æ–±–ª–∞–∫–µ –≤—ã–¥–µ–ª–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ "iac" —Å id=b1gjap7i9e06sdcbetb4  

<br>  

## –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–¥ –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞

–í YC C–æ–∑–¥–∞—Ç—å 4 –Ω–æ–¥—ã —Å –æ–±—Ä–∞–∑–æ–º Ubuntu 20.04 LTS:  
master - 1 —ç–∫–∑–µ–º–ø–ª—è—Ä (intel ice lake, 2vCPU, 8 GB RAM)  
worker - 3 —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ (intel ice lake, 2vCPU, 8 GB RAM)  

–ü—É–±–ª–∏—á–Ω—ã–π ip –∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–∏–º —Ç–æ–ª—å–∫–æ –º–∞—Å—Ç–µ—Ä—É, –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è 
–∫–ª–∞—Å—Ç–µ—Ä–æ–º –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞. –î–æ—Å—Ç—É–ø –∫ worker –Ω–æ–¥–∞–º –±—É–¥–µ–º –æ—Å—É—â–µ—Å—Ç–≤–ª—è—Ç—å —Å master –Ω–æ–¥—ã, 
–¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å worker –∑–∞–∫–∞—á–∏–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–∞–∑–Ω–∞—á–∏–º nat —à–ª—é–∑ 
(egress).  

–ü–æ–¥–±–æ—Ä –æ–±—Ä–∞–∑–∞ —Å —Ç—Ä–µ–±—É–µ–º–æ–π –æ—Å:  
```bash
$ yc compute image list --folder-id standard-images 
+----------------------+----------------------------+-----------------+----------------------+--------+
|          ID          |           NAME             |     FAMILY      |      PRODUCT IDS     | STATUS |
+----------------------+----------------------------+-----------------+----------------------+--------+
| ...                                                                                                 |
| fd85an6q1o26nf37i2nl | ubuntu-20-04-lts-v20231218 | ubuntu-2004-lts | f2ekp29fd7vk7pke4hj5 | READY  |
| ...                                                                                                 |
+----------------------+----------------------------+-----------------+----------------------+--------+
```  

–°–æ–∑–¥–∞–Ω–∏–µ —á–µ—Ä–µ–∑ terraform –≤ [–ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ iac](/kubernetes-prod/iac/)  

```bash
$ cd kubernetes-prod/iac
$ tf init
$ tf plan 
$ tf apply --auto-approve

...
Outputs:

master_hostname = "master"
master_private_ip = "192.168.10.10"
master_public_ip = "< —Å–∫—Ä—ã—Ç–æ >"
worker_nodes_hostnames = [
  "worker-1",
  "worker-2",
  "worker-3",
]
worker_nodes_private_ips = [
  "192.168.10.11",
  "192.168.10.12",
  "192.168.10.13",
]
```  
–î–ª—è —É–¥–æ–±–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –ø–æ ssh –≤–Ω–µ—Å–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ –≤ /etc/hosts  
–∏ –≤ ~/.ssh/config:  
```bash
$ cat <<EOF >>~/.ssh/config
Host master
  Hostname < —Å–∫—Ä—ã—Ç–æ >
  User ubuntu
  Port 22
  IdentityFile /home/anduser/.ssh/id_rsa
EOF

$ echo '< —Å–∫—Ä—ã—Ç–æ > master kubernetes' | sudo tee -a /etc/hosts

$ ssh master
```

SSH –¥–æ—Å—Ç—É–ø –Ω–∞ –≤–æ—Ä–∫–µ—Ä—ã –±—É–¥–µ—Ç —Ç–æ–ª—å–∫–æ —Å –º–∞—Å—Ç—Ä –Ω–æ–¥—ã, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ–ø–∏—Å—ã–≤–∞–µ–º —Ö–æ—Å—Ç—ã –∏  
–¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–ª—é—á ~/.ssh/id_rsa:  
```bash
# –Ω–∞ –º–∞—Å—Ç–µ—Ä –Ω–æ–¥–µ
$ cat <<EOF | sudo tee -a /etc/hosts
192.168.10.10 master
192.168.10.11 worker-1
192.168.10.12 worker-2
192.168.10.13 worker-3
EOF

$ cat <<EOF >>~/.ssh/config
Host worker-1
  Hostname 192.168.10.11
  User ubuntu
  Port 22
  IdentityFile /home/ubuntu/.ssh/id_rsa
Host worker-2
  Hostname 192.168.10.12
  User ubuntu
  Port 22
  IdentityFile /home/ubuntu/.ssh/id_rsa
Host worker-3
  Hostname 192.168.10.13
  User ubuntu
  Port 22
  IdentityFile /home/ubuntu/.ssh/id_rsa
EOF
```  

–ò –Ω–∞ –≤—Å–µ—Ö –≤–æ—Ä–µ–∫–µ—Ä–∞—Ö –ø—Ä–æ–ø–∏—Å—ã–≤–∞–µ–º hosts c —á–ª–µ–Ω–∞–º–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞  
<br>  

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –º–∞—à–∏–Ω

–ù–∞ –≤—Å–µ—Ö –º–∞—à–∏–Ω–∞—Ö –≤—ã–ø–æ–ª–Ω—è–µ–º
```bash
# –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ swap
$ sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
$ sudo swapoff -a
```  

<br>  

## –ó–∞–≥—Ä—É–∑–∏–º br_netfilter, –ø–æ–∑–≤–æ–ª–∏–º iptables –≤–∏–¥–µ—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –≤–∫–ª—é—á–∏–º forwarding 

```bash
$ cat <<EOF | sudo tee /etc/modules-load.d/containerd.conf
overlay
br_netfilter
EOF

$ sudo modprobe overlay
$ sudo modprobe br_netfilter

$ cat <<EOF | sudo tee /etc/sysctl.d/kubernetes.conf
net.bridge.bridge-nf-call-iptables=1 
net.ipv4.ip_forward=1 
net.bridge.bridge-nf-call-ip6tables=1 
EOF

$ sudo sysctl --system
```  

<br>  

##  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ containerd

```bash
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
$ sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
$ sudo apt update -y
$ sudo apt install -y containerd.io
$ sudo mkdir -p /etc/containerd
$ containerd config default | sudo tee /etc/containerd/config.toml
$ sudo systemctl restart containerd
$ sudo systemctl enable containerd
```  

<br>  

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ kubectl, kubeadm, kubelet
```bash
$ sudo apt-get update && sudo apt-get install -y apt-transport-https curl
$ curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
$ echo "deb https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list
$ sudo apt update -y
$ sudo apt -y install vim git curl wget kubelet=1.23.0-00 kubeadm=1.23.0-00 kubectl=1.23.0-00
$ sudo apt-mark hold kubelet kubeadm kubectl
$ sudo kubeadm config images pull --cri-socket /run/containerd/containerd.sock --kubernetes-version v1.23.0
```  

<br>  

## –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞

```bash
$ sudo kubeadm init \
  --apiserver-cert-extra-sans < –ø—É–±–ª–∏—á–Ω—ã–π IP master node >[,< –¥–æ–ø. –¥–æ–º–µ–Ω –∏–ª–∏ IP >] \
  --pod-network-cidr=10.244.0.0/16 \
  --upload-certs \
  --kubernetes-version=v1.23.0 \
  --cri-socket /run/containerd/containerd.sock
```  

<br>  

## –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥ kubectl

C–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–ª–∞—Å—Ç–µ—Ä—É –∏–∑ 
**/etc/kubernetes/admin.conf** –º–∞—Å—Ç–µ—Ä –Ω–æ–¥—ã –∏ –≤–ø–∏—Å–∞—Ç—å –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è 
**~/.kube/config** —Å–≤–æ–µ–π –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã.  
–ü—Ä–æ–≤–µ—Ä–∫–∞:  
```bash
# c –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã
$ k cluster-info 
Kubernetes control plane is running at https://< —Å–∫—Ä—ã—Ç–æ >:6443
CoreDNS is running at https://< —Å–∫—Ä—ã—Ç–æ >:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
anduser@shamil:~$ k get nodes
NAME     STATUS     ROLES                  AGE     VERSION
master   NotReady   control-plane,master   5m46s   v1.23.0
```  

<br>  

## –£—Å—Ç–∞–Ω–æ–≤–∏–º —Å–µ—Ç–µ–≤–æ–π –ø–ª–∞–≥–∏–Ω

–í—ã–±–∏—Ä–∞—é –ø–ª–∞–≥–∏–Ω [Cilium](https://cilium.io/)  

### Cilium CLI - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏

–£—Å—Ç–∞–Ω–∞–≤–∫—É cilium cli –∏ —Å–∞–º–æ–≥–æ cilium –≤—ã–ø–æ–ª–Ω—è–µ–º —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞, 
–æ—Ç—Ç—É–¥–∞ –∂–µ, –≥–¥–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω **kubectl**  

```bash
CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)
CLI_ARCH=amd64
if [ "$(uname -m)" = "aarch64" ]; then CLI_ARCH=arm64; fi
curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum
sudo tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin
rm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
```

### Cilium
```bash
$ helm repo update
$ cilium install --version 1.14.5
$ cilium status
    /¬Ø¬Ø\
 /¬Ø¬Ø\__/¬Ø¬Ø\    Cilium:             OK
 \__/¬Ø¬Ø\__/    Operator:           OK
 /¬Ø¬Ø\__/¬Ø¬Ø\    Envoy DaemonSet:    disabled (using embedded mode)
 \__/¬Ø¬Ø\__/    Hubble Relay:       disabled
    \__/       ClusterMesh:        disabled

Deployment             cilium-operator    Desired: 1, Ready: 1/1, Available: 1/1
DaemonSet              cilium             Desired: 1, Ready: 1/1, Available: 1/1
Containers:            cilium-operator    Running: 1
                       cilium             Running: 1
Cluster Pods:          2/2 managed by Cilium
Helm chart version:    1.14.5
Image versions         cilium             quay.io/cilium/cilium:v1.14.5@sha256:d3b287029755b6a47dee01420e2ea469469f1b174a2089c10af7e5e9289ef05b: 1
                       cilium-operator    quay.io/cilium/operator-generic:v1.14.5@sha256:303f9076bdc73b3fc32aaedee64a14f6f44c8bb08ee9e3956d443021103ebe7a: 1
```    

<br>  

## –ü–æ–¥–∫–ª—é—á–∞–µ–º worker –Ω–æ–¥—ã

–ü–æ–ª—É—á–∞–µ–º –∫–æ–º–∞–Ω–¥—É –¥–ª—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–∞ –º–∞—Å—Ç–µ—Ä –Ω–æ–¥–µ:  
```bash
$ sudo kubeadm token create --print-join-command

kubeadm join 192.168.10.10:6443 --token < —Å–∫—Ä—ã—Ç–æ > --discovery-token-ca-cert-hash < —Å–∫—Ä—ã—Ç–æ >  
```  

–ò–¥–µ–º –Ω–∞ –∫–∞–∂–¥—ã–π –∏–∑ –≤–æ—Ä–∫–µ—Ä–æ–≤ –∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º –∏—Ö:  
```bash
$ sudo kubeadm join 192.168.10.10:6443 \
  --token < —Å–∫—Ä—ã—Ç–æ > \
  --discovery-token-ca-cert-hash < —Å–∫—Ä—ã—Ç–æ >
```  

–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã:  
```bash
$ k get nodes -o wide
NAME       STATUS   ROLES                  AGE     VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
master     Ready    control-plane,master   35m     v1.23.0   192.168.10.10   <none>        Ubuntu 20.04.6 LTS   5.4.0-169-generic   containerd://1.6.26
worker-1   Ready    <none>                 3m53s   v1.23.0   192.168.10.11   <none>        Ubuntu 20.04.6 LTS   5.4.0-169-generic   containerd://1.6.26
worker-2   Ready    <none>                 88s     v1.23.0   192.168.10.12   <none>        Ubuntu 20.04.6 LTS   5.4.0-169-generic   containerd://1.6.26
worker-3   Ready    <none>                 68s     v1.23.0   192.168.10.13   <none>        Ubuntu 20.04.6 LTS   5.4.0-169-generic   containerd://1.6.26
```  

<br>  

## –ó–∞–ø—É—Å–∫ –Ω–∞–≥—Ä—É–∑–∫–∏

```bash
$ k create deploy nginx-deployment \
  --replicas=4 \
  --image=nginx:1.17.2

deployment.apps/nginx-deployment created

$ k get pods -o wide
NAME                               READY   STATUS    RESTARTS   AGE   IP           NODE       NOMINATED NODE   READINESS GATES
nginx-deployment-fc796d66c-fhp65   1/1     Running   0          20s   10.0.2.139   worker-2   <none>           <none>
nginx-deployment-fc796d66c-kpt59   1/1     Running   0          20s   10.0.3.137   worker-3   <none>           <none>
nginx-deployment-fc796d66c-rc224   1/1     Running   0          20s   10.0.1.85    worker-1   <none>           <none>
nginx-deployment-fc796d66c-szvbs   1/1     Running   0          20s   10.0.1.138   worker-1   <none>           <none>
```  

<br>  

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞

–¢–∞–∫ –∫–∞–∫ –∫–ª–∞—Å—Ç–µ—Ä —Å–æ–∑–¥–∞–≤–∞–ª—Å—è kubeadm, —Ç–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –µ–≥–æ –±—É–¥–µ–º –∏–º –∂–µ. –°–Ω–∞—á–∞–ª–∞ 
master, –ø–æ—Ç–æ–º - worker –Ω–æ–¥—ã.  

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞  
```bash
$ sudo apt update
$ apt-cache madison kubeadm
$ sudo apt-get install kubeadm='1.24.17-00' \
  -y \
  --allow-change-held-packages
$ sudo kubeadm upgrade plan
$ sudo kubeadm upgrade apply v1.24.17
```  

–í–µ—Ä—Å–∏—è kubelet –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π:
```bash
$ k get nodes
NAME       STATUS   ROLES           AGE    VERSION
master     Ready    control-plane   3h9m   v1.23.0
worker-1   Ready    <none>          157m   v1.23.0
worker-2   Ready    <none>          154m   v1.23.0
worker-3   Ready    <none>          154m   v1.23.0
```  

–ù–æ –≤–µ—Ä—Å–∏—è api —Å–µ—Ä–≤–µ—Ä–∞ (–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ control plane) –ø–æ–º–µ–Ω—è–ª–∞—Å—å:
```bash
$ k version --short | grep Server
Server Version: v1.24.17
```  

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ kubelet –∏ kubectl –Ω–∞ master node

–î—Ä–µ–Ω–∏—Ä—É–µ–º –Ω–∞–≥—Ä—É–∑–∫—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º:
```bash
# –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
$ k drain master --ignore-daemonsets

# –Ω–∞ master –Ω–æ–¥–µ:
$ sudo apt-get install kubelet='1.24.17-00' kubectl='1.24.17-00' \
  -y \
  --allow-change-held-packages 
$ sudo systemctl daemon-reload
$ sudo systemctl restart kubelet

# –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
$ k uncordon master
$ k get nodes

NAME       STATUS   ROLES           AGE     VERSION
master     Ready    control-plane   3h54m   v1.24.17
worker-1   Ready    <none>          3h23m   v1.23.0
worker-2   Ready    <none>          3h20m   v1.23.0
worker-3   Ready    <none>          3h20m   v1.23.0
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ worker nodes

–û–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –Ω–∞ –∫–∞–∂–¥–æ–π –∏–∑ worker –Ω–æ–¥. –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ –æ—á–µ—Ä–µ–¥–∏, —Å–Ω–∞—á–∞–ª–∞ 
–ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–¥–Ω—É –Ω–æ–¥—É, –∏, –ø–æ—Å–ª–µ –µ–µ –≤–≤–æ–¥–∞ –≤ —Å—Ä–æ–π, - –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ª–µ–¥—É—é—â—É—é.  

<br>  

–û–±–Ω–æ–≤–ª—è–µ–º kubeadm –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–∞ –Ω–æ–¥–µ:  
```bash
$ sudo apt update
$ apt-cache madison kubeadm
$ sudo apt-get install kubeadm='1.24.17-00' \
  -y \
  --allow-change-held-packages
$ sudo kubeadm upgrade node
```
–î—Ä–µ–Ω–∏—Ä—É–µ–º –Ω–∞–≥—Ä—É–∑–∫—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º kubelet
```bash
# –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
$ k drain worker-1 --ignore-daemonsets

# –Ω–∞ worker-1
$ sudo apt-get install kubelet='1.24.17-00' kubectl='1.24.17-00' \
  -y \
  --allow-change-held-packages
$ sudo systemctl daemon-reload
$ sudo systemctl restart kubelet

# –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
$ k uncordon worker-1
```  

### –ü—Ä–æ—Å–º–æ—Ç—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
```bash
$ k get nodes
NAME       STATUS   ROLES           AGE     VERSION
master     Ready    control-plane   4h23m   v1.24.17
worker-1   Ready    <none>          3h52m   v1.24.17
worker-2   Ready    <none>          3h49m   v1.24.17
worker-3   Ready    <none>          3h49m   v1.24.17
```  

<br>  

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤

–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è –±—É–¥—É –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–¥ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.  
–ò –∑–∞–Ω–æ–≤–æ –ø—Ä–æ–∏–∑–≤–µ–¥—É —É—Å—Ç–∞–Ω–æ–≤–∫—É –∫–ª–∞—Å—Ç–µ—Ä–∞, —É–∂–µ –ø—Ä–∏ –ø–æ–º–æ—â–∏ 
[kubespray](https://github.com/kubernetes-sigs/kubespray).   
–ü—É–±–ª–∏—á–Ω—ã–π IP –∞–¥—Ä–µ—Å –±—É–¥–µ—Ç —Ç–∞–∫–∂–µ —Ç–æ–ª—å–∫–æ —É –º–∞—Å—Ç–µ—Ä –Ω–æ–¥—ã, –ø–æ—ç—Ç–æ–º—É –∑–∞–ø—É—Å–∫–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–∏ 
–±—É–¥—É —Å –Ω–µ–µ.  

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Kubespray

### –ü—Ä–µ—Ä–µ–∫–≤–∏–∑–∏—Ç—ã - python3 –∏ pip

–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º requirements.txt –º–∞—Å—Ç–µ—Ä –≤–µ—Ç–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ Kubespray, 
–∏—Å–ø–æ–ª—å–∑—É—è –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤ Ubuntu20.04, –æ–∫–∞–∑–∞–ª–æ—Å—å –≤–µ—Å—å–º–∞ –Ω–µ—Ç—Ä–∏–≤–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–∞—á–µ–π:  
```bash
$ sudo add-apt-repository ppa:deadsnakes/ppa
$ sudo apt-get update
$ sudo apt-get install python3.11
$ sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 2
$ sudo update-alternatives --config python3
# —É—Å—Ç–∞–Ω–æ–≤–∫–∞ pip –æ—Ç —Ä—É—Ç–∞:
$ sudo -i
# curl https://bootstrap.pypa.io/get-pip.py | python3
# exit

$ python3 -V
Python 3.11.7

$ pip -V
pip 23.3.2 from /home/ubuntu/.local/lib/python3.11/site-packages/pip (python 3.11)

# –ø–ª—é—Å –µ—â–µ –Ω–µ–º–Ω–æ–≥–æ "–ø—Ä–∏—Å–µ–¥–∞–Ω–∏–π" –≤ —Å–≤—è–∑–∏ —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º apt_pkg:
$ cd /usr/lib/python3/dist-packages
$ sudo ln -s apt_pkg.cpython-38-x86_64-linux-gnu.so apt_pkg.so
$ sudo ln -s apt_inst.cpython-38-x86_64-linux-gnu.so apt_inst.so
```

### –ü—Ä–µ—Ä–µ–∫–≤–∏–∑–∏—Ç—ã - SSH –¥–æ—Å—Ç—É–ø
–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–¥ –∫–ª–∞—Å—Ç–µ—Ä–∞ –∏ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ SSH –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ 
[–ø–µ—Ä–≤–æ–π —á–∞—Å—Ç–∏ –∑–∞–¥–∞–Ω–∏—è](./14_25_kubernetes_prod.MD#—Å–æ–∑–¥–∞–Ω–∏–µ-–Ω–æ–¥-–¥–ª—è-–∫–ª–∞—Å—Ç–µ—Ä–∞).  

### –ü–æ–ª—É—á–µ–Ω–∏–µ Kubespray
```bash
$ sudo apt install -y git
$ git clone https://github.com/kubernetes-sigs/kubespray.git
```  

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
$ cd kubespray/
$ sudo pip install -r requirements.txt
$ ansible --version

ansible [core 2.15.8]
  config file = /home/ubuntu/kubespray/ansible.cfg
  configured module search path = ['/home/ubuntu/kubespray/library']
  ansible python module location = /usr/local/lib/python3.11/dist-packages/ansible
  ansible collection location = /home/ubuntu/.ansible/collections:/usr/share/ansible/collections
  executable location = /usr/local/bin/ansible
  python version = 3.11.7 (main, Dec  8 2023, 18:56:57) [GCC 9.4.0] (/usr/bin/python3)
  jinja version = 3.1.2
  libyaml = False
```  

### –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è

```bash
cp -rfp inventory/sample inventory/kubernetes-prod
```  

–ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å —Å 
[—Ç–∞–∫–∏–º](/kubernetes-prod/kubespray-inventory/inventory.ini) —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ–º  

–ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –ø—Ä–∞–≤–∏–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:  
**inventory/kubernetes-prod/group_vars/all/all.yml**  
**inventory/kubernetes-prod/group_vars/k8s_cluster/k8s-cluster.yml**  

–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å—Ü–µ–Ω–∞—Ä–∏–π –∫–æ–º–∞–Ω–¥–æ–π:  
```bash
$ ansible-playbook \
  -i inventory/kubernetes-prod/inventory.ini \
  --become \
  --become-user=root \
  --user=ubuntu \
  --key-file=/home/ubuntu/.ssh/id_rsa cluster.yml
```  

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç—Ä–∞–±–æ—Ç–∫–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è —Å—Ö–æ–¥–∏—Ç—å –Ω–∞ master –Ω–æ–¥—É –∑–∞ kubeconfig 
—Ñ–∞–π–ª–æ–º, –ø–æ –ø—É—Ç–∏ **/etc/kubernetes/admin.conf**  

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏:  
```bash
$ k get nodes
NAME       STATUS   ROLES           AGE     VERSION
master     Ready    control-plane   8m24s   v1.28.5
worker-1   Ready    <none>          7m29s   v1.28.5
worker-2   Ready    <none>          7m29s   v1.28.5
worker-3   Ready    <none>          7m28s   v1.28.5

$ k cluster-info 
Kubernetes control plane is running at https://kubernetes:6443

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
```  

–î–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ api —Å–µ—Ä–≤–µ—Ä—É, –µ–≥–æ –∞–¥—Ä–µ—Å –≤ kubeconfig –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ 
–∫–æ–º–ø—å—é—Ç–µ—Ä–∞ —É–∫–∞–∑—ã–≤–∞–µ–º –Ω–µ –∫–∞–∫ ip, –∞ –∫–∞–∫ –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è kubernetes. –í hosts —Ñ–∞–π–ª–µ 
–ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –≤–Ω–µ—Å—Ç–∏ –∑–∞–ø–∏—Å—å, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–∑—Ä–µ—à–∞–µ—Ç kubernetes –≤ 
–ø—É–±–ª–∏—á–Ω—ã–π ip –∞–¥—Ä–µ—Å api —Å–µ—Ä–≤–µ—Ä–∞.  

```bash
$ grep kubernetes /etc/hosts
< –ø—É–±–ª–∏—á–Ω—ã–π IP master –Ω–æ–¥—ã > master kubernetes
```  

<br>  

## –ó–∞–¥–∞–Ω–∏–µ —Å–æ üåü

–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è —Å–æ üåü –Ω–µ–º–Ω–æ–≥–æ –∏–∑–º–µ–Ω–∏—Ç—Å—è –∫–æ–¥ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.  
–î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø–∞—Ä–∞ –º–∞—Å—Ç–µ—Ä –Ω–æ–¥, –≤–Ω–µ—à–Ω–∏–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –∏ –¥–∂–∞–º–ø —Ö–æ—Å—Ç.   
Terraform –∫–æ–¥ —Ä–∞–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ–ø–∏—Å–∞–Ω –≤ –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ 
[iac-advanced](/kubernetes-prod/iac-advanced/).   
–£—Å—Ç–∞–Ω–æ–≤–∫—É –∫–ª–∞—Å—Ç–µ—Ä–∞ –±—É–¥—É –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å —É–∂–µ –ø—Ä–∏ –ø–æ–º–æ—â–∏ 
[kubespray](https://github.com/kubernetes-sigs/kubespray).   
–ü—É–±–ª–∏—á–Ω—ã–π IP –∞–¥—Ä–µ—Å –±—É–¥–µ—Ç —Ç–æ–ª—å–∫–æ —É –¥–∂–∞–º–ø —Ö–æ—Å—Ç–∞ bastion, –ø–æ—ç—Ç–æ–º—É –∑–∞–ø—É—Å–∫–∞—Ç—å 
—Å—Ü–µ–Ω–∞—Ä–∏–∏ –±—É–¥—É —Å –Ω–µ–≥–æ.  
–î–æ—Å—Ç—É–ø –∫ api —Å–µ—Ä–≤–µ—Ä–∞–º –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ –æ–±–ª–∞—á–Ω—ã–π L3/L4 –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫.  

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã

```bash
$ cat <<EOF | sudo tee -a /etc/hosts
< –ø—É–±–ª–∏—á–Ω—ã–π IP —Ö–æ—Å—Ç–∞ bastion > bastion
EOF

$ cat <<EOF >>~/.ssh/config
Host bastion
  Hostname < –ø—É–±–ª–∏—á–Ω—ã–π IP —Ö–æ—Å—Ç–∞ bastion >
  User ubuntu
  Port 22
EOF
```  

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ö–æ—Å—Ç–∞ bastion

```bash
# –Ω–∞ —Ö–æ—Å—Ç–µ bastion
$ cat <<EOF | sudo tee -a /etc/hosts
192.168.10.11 master-1
192.168.10.12 master-2
192.168.10.13 master-3
192.168.10.21 worker-1
192.168.10.22 worker-2
EOF

$ cat <<EOF >>~/.ssh/config
Host master-1
  Hostname 192.168.10.11
  User ubuntu
  Port 22
  IdentityFile /home/ubuntu/.ssh/id_rsa
Host master-2
  Hostname 192.168.10.12
  User ubuntu
  Port 22
  IdentityFile /home/ubuntu/.ssh/id_rsa
Host master-3
  Hostname 192.168.10.13
  User ubuntu
  Port 22
  IdentityFile /home/ubuntu/.ssh/id_rsa
Host worker-1
  Hostname 192.168.10.21
  User ubuntu
  Port 22
  IdentityFile /home/ubuntu/.ssh/id_rsa
Host worker-2
  Hostname 192.168.10.22
  User ubuntu
  Port 22
  IdentityFile /home/ubuntu/.ssh/id_rsa
EOF
```  

### –ü—Ä–µ—Ä–µ–∫–≤–∏–∑–∏—Ç—ã - python3 –∏ pip

–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º requirements.txt –º–∞—Å—Ç–µ—Ä –≤–µ—Ç–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ Kubespray, 
–∏—Å–ø–æ–ª—å–∑—É—è –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤ Ubuntu20.04, –æ–∫–∞–∑–∞–ª–æ—Å—å –≤–µ—Å—å–º–∞ –Ω–µ—Ç—Ä–∏–≤–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–∞—á–µ–π:  
```bash
$ sudo add-apt-repository ppa:deadsnakes/ppa
$ sudo apt-get update
$ sudo apt-get install python3.11 -y 
$ sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 2
$ sudo update-alternatives --config python3
# —É—Å—Ç–∞–Ω–æ–≤–∫–∞ pip –æ—Ç —Ä—É—Ç–∞:
$ sudo -i
# curl https://bootstrap.pypa.io/get-pip.py | python3
# exit

$ python3 -V
Python 3.11.7

$ pip -V
pip 23.3.2 from /home/ubuntu/.local/lib/python3.11/site-packages/pip (python 3.11)

# –ø–ª—é—Å –µ—â–µ –Ω–µ–º–Ω–æ–≥–æ "–ø—Ä–∏—Å–µ–¥–∞–Ω–∏–π" –≤ —Å–≤—è–∑–∏ —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º apt_pkg:
$ cd /usr/lib/python3/dist-packages
$ sudo ln -s apt_pkg.cpython-38-x86_64-linux-gnu.so apt_pkg.so
$ sudo ln -s apt_inst.cpython-38-x86_64-linux-gnu.so apt_inst.so
```   

### –ü–æ–ª—É—á–µ–Ω–∏–µ Kubespray
```bash
$ sudo apt install -y git
$ git clone https://github.com/kubernetes-sigs/kubespray.git
```  

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
$ cd kubespray/
$ sudo pip install -r requirements.txt
$ ansible --version

ansible [core 2.15.8]
  config file = /home/ubuntu/kubespray/ansible.cfg
  configured module search path = ['/home/ubuntu/kubespray/library']
  ansible python module location = /usr/local/lib/python3.11/dist-packages/ansible
  ansible collection location = /home/ubuntu/.ansible/collections:/usr/share/ansible/collections
  executable location = /usr/local/bin/ansible
  python version = 3.11.7 (main, Dec  8 2023, 18:56:57) [GCC 9.4.0] (/usr/bin/python3)
  jinja version = 3.1.2
  libyaml = False
```  

### –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è

```bash
cp -rfp inventory/sample inventory/kubernetes-prod
```  

### –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º hosts.yml

```bash
$ declare -a IPS=(192.168.10.11 192.168.10.12 192.168.10.13 192.168.10.21 192.168.10.22)
$ CONFIG_FILE=inventory/kubernetes-prod/hosts.yml python3 contrib/inventory_builder/inventory.py ${IPS[@]}
```  
–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º inventory/kubernetes-prod/hosts.yml  

### –ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏—è

```bash
$ ansible-playbook \
  -i inventory/kubernetes-prod/hosts.yml \
  --become \
  --become-user=root \
  --user=ubuntu \
  --key-file=/home/ubuntu/.ssh/id_rsa cluster.yml
```  

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏  
  
–° –º–∞—Å—Ç–µ—Ä –Ω–æ–¥—ã:  
```bash
$ sudo kubectl --kubeconfig /etc/kubernetes/admin.conf get nodes -o wide
NAME    STATUS   ROLES           AGE     VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
node1   Ready    control-plane   6m6s    v1.28.5   192.168.10.11   <none>        Ubuntu 20.04.6 LTS   5.4.0-169-generic   containerd://1.7.11
node2   Ready    control-plane   5m45s   v1.28.5   192.168.10.12   <none>        Ubuntu 20.04.6 LTS   5.4.0-169-generic   containerd://1.7.11
node3   Ready    control-plane   5m39s   v1.28.5   192.168.10.13   <none>        Ubuntu 20.04.6 LTS   5.4.0-169-generic   containerd://1.7.11
node4   Ready    <none>          4m43s   v1.28.5   192.168.10.21   <none>        Ubuntu 20.04.6 LTS   5.4.0-169-generic   containerd://1.7.11
node5   Ready    <none>          4m43s   v1.28.5   192.168.10.22   <none>        Ubuntu 20.04.6 LTS   5.4.0-169-generic   containerd://1.7.11
```  

–ù–∞—Å—Ç—Ä–æ–∏–≤ kubeconfig –∏ hosts –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ:  
```bash
$ grep kubernetes /etc/hosts
178.154.206.101 kubernetes

$ k cluster-info 
Kubernetes control plane is running at https://kubernetes:6443
To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.

$ k get nodes -o wide
NAME    STATUS   ROLES           AGE   VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
node1   Ready    control-plane   13m   v1.28.5   192.168.10.11   <none>        Ubuntu 20.04.6 LTS   5.4.0-169-generic   containerd://1.7.11
node2   Ready    control-plane   13m   v1.28.5   192.168.10.12   <none>        Ubuntu 20.04.6 LTS   5.4.0-169-generic   containerd://1.7.11
node3   Ready    control-plane   13m   v1.28.5   192.168.10.13   <none>        Ubuntu 20.04.6 LTS   5.4.0-169-generic   containerd://1.7.11
node4   Ready    <none>          12m   v1.28.5   192.168.10.21   <none>        Ubuntu 20.04.6 LTS   5.4.0-169-generic   containerd://1.7.11
node5   Ready    <none>          12m   v1.28.5   192.168.10.22   <none>        Ubuntu 20.04.6 LTS   5.4.0-169-generic   containerd://1.7.11
```  

–ü–æ–ª—É—á–∏–ª–∏ –∫–ª–∞—Å—Ç–µ—Ä –Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –∞–¥—Ä–µ—Å–∞—Ö, —Ç–µ–º –Ω–µ –º–µ–Ω–µ–µ —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º –≤ 
–∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ api —Å–µ—Ä–≤–µ—Ä–æ–º.   

### TODO
–†–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ kubespray –¥–ª—è –±–æ–ª–µ–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π 
–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–∞ –≤ –∫–ª–∞—Å—Ç–µ—Ä.  
